{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-12 text-center">
            <h2 class="fw-bold">AI Posture Correction & Fitness Trainer</h2>
            <p class="text-muted">Real-time analysis using computer vision. Ensure you are well-lit and your full body
                is visible.</p>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow feature-card">
                <div class="card-body p-0 position-relative">
                    <div id="loading"
                        class="d-flex justify-content-center align-items-center position-absolute w-100 h-100 bg-white"
                        style="z-index: 10;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading AI...</span>
                        </div>
                        <span class="ms-3">Loading AI Models... Please wait.</span>
                    </div>

                    <video class="input_video" style="display: none;"></video>
                    <canvas class="output_canvas" width="800" height="480"
                        style="width: 100%; height: auto; border-radius: 12px;"></canvas>

                    <div id="feedback-overlay"
                        class="position-absolute bottom-0 start-0 w-100 p-3 bg-dark bg-opacity-50 text-white text-center rounded-bottom">
                        <h4 id="status-text">Waiting for Pose...</h4>
                        <div id="score-counter" class="fs-4">Reps/Time: <span id="rep-count">0</span> | Score: <span
                                id="score-val">100</span>%</div>
                    </div>
                </div>
                <div class="card-footer d-grid">
                    <button class="btn btn-danger btn-lg" onclick="endSession()">End Session & Save to
                        Dashboard</button>
                    <div id="save-status" class="alert alert-info small mt-2" style="display:none;"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    Instructions
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="exercise-select" class="form-label fw-bold">Select Activity:</label>
                        <select class="form-select" id="exercise-select" onchange="resetSession()">
                            <option value="Squats">Squats (Legs)</option>
                            <option value="Yoga">Yoga (Warrior II)</option>
                            <option value="Stretching">Stretching (Side Reach)</option>
                            <option value="Pushups">Pushups (Chest)</option>
                        </select>
                    </div>
                    <ul class="list-group list-group-flush small" id="instruction-list">
                        <li class="list-group-item">1. Stand back 5-6 feet.</li>
                        <li class="list-group-item">2. Keep back straight.</li>
                        <li class="list-group-item">3. Squat until thighs parallel.</li>
                    </ul>
                    <hr>
                    <div class="d-grid">
                        <button class="btn btn-outline-primary" id="start-cam" onclick="location.reload()">Restart
                            Camera</button>
                    </div>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    Live Analysis
                </div>
                <div class="card-body">
                    <p><strong>Detected Activity:</strong> <span id="ex-name">Squat</span></p>
                    <p><strong>Status:</strong> <span id="visibility" class="badge bg-secondary">Camera Active</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MediaPipe Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

<script>
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');
    const loadingDiv = document.getElementById('loading');
    const statusText = document.getElementById('status-text');
    const repCountSpan = document.getElementById('rep-count');
    const scoreValSpan = document.getElementById('score-val');
    const exerciseSelect = document.getElementById('exercise-select');
    const exNameSpan = document.getElementById('ex-name');
    const instructionList = document.getElementById('instruction-list');

    let reps = 0;
    let stage = "UP"; // UP or DOWN
    let postureScore = 100;
    let lastFeedbackTime = 0;
    let currentExercise = "Squats";
    let yogaTimer = 0;
    let yogaHolding = false;

    // --- Helper: Text to Speech ---
    function speak(text) {
        const now = Date.now();
        if (now - lastFeedbackTime > 4000) {
            const msg = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(msg);
            lastFeedbackTime = now;
        }
    }

    // --- Helper: Calculate Angle ---
    function findAngle(a, b, c) {
        const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
        let angle = Math.abs(radians * 180.0 / Math.PI);
        if (angle > 180.0) angle = 360 - angle;
        return angle;
    }

    function resetSession() {
        reps = 0;
        postureScore = 100;
        stage = "UP";
        yogaTimer = 0;
        yogaHolding = false;
        repCountSpan.innerText = "0";
        currentExercise = exerciseSelect.value;
        exNameSpan.innerText = currentExercise;

        // Update Instructions
        if (currentExercise === 'Squats') {
            instructionList.innerHTML = `
                <li class="list-group-item">1. Full body visible.</li>
                <li class="list-group-item">2. Keep back straight.</li>
                <li class="list-group-item">3. Squat < 90 deg.</li>`;
        } else if (currentExercise === 'Yoga') {
            instructionList.innerHTML = `
                <li class="list-group-item">1. Warrior II Pose.</li>
                <li class="list-group-item">2. Arms horizontal.</li>
                <li class="list-group-item">3. Bend front knee.</li>`;
        } else if (currentExercise === 'Stretching') {
            instructionList.innerHTML = `
                <li class="list-group-item">1. Stand straight.</li>
                <li class="list-group-item">2. Reach highly with one arm.</li>
                <li class="list-group-item">3. Lean to side.</li>`;
        } else {
            instructionList.innerHTML = `
                <li class="list-group-item">1. Side view on ground.</li>
                <li class="list-group-item">2. Straight body line.</li>
                <li class="list-group-item">3. Chest to floor.</li>`;
        }
    }

    function onResults(results) {
        loadingDiv.style.display = 'none';

        // 1. Prepare Canvas
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
            // 2. Draw Skeleton
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                { color: '#00FF00', lineWidth: 4 });
            drawLandmarks(canvasCtx, results.poseLandmarks,
                { color: '#FF0000', lineWidth: 2 });

            const landmarks = results.poseLandmarks;
            let angle = 0;
            let targetJoint = null;

            // 3. Logic per Exercise
            if (currentExercise === 'Squats') {
                // Hip-Knee-Ankle (Left)
                const hip = landmarks[23];
                const knee = landmarks[25];
                const ankle = landmarks[27];

                if (hip && knee && ankle) {
                    angle = findAngle(hip, knee, ankle);
                    targetJoint = knee;

                    if (angle > 160) {
                        stage = "UP";
                        statusText.innerText = "Stand Straight";
                        statusText.className = "text-white";
                    }
                    if (angle < 90 && stage === "UP") {
                        stage = "DOWN";
                        reps++;
                        speak("Good Squat");
                        statusText.innerText = "Good Depth!";
                        statusText.className = "text-success fw-bold";
                    }
                }
            }
            else if (currentExercise === 'Yoga') {
                // Warrior II: Arms horizontal (Shoulder-Shoulder-Elbow ~180?), Front Knee Bent
                // Using Angle of Left Knee (Front)
                const lHip = landmarks[23];
                const lKnee = landmarks[25];
                const lAnkle = landmarks[27];
                // Check arms roughly horizontal - simplified to Knee Hold time

                if (lHip && lKnee && lAnkle) {
                    angle = findAngle(lHip, lKnee, lAnkle);
                    targetJoint = lKnee;

                    if (angle < 130 && angle > 70) { // Holding pose
                        if (!yogaHolding) {
                            yogaHolding = true;
                            speak("Hold the pose");
                        }
                        yogaTimer += 0.05; // Approx frame time
                        reps = Math.floor(yogaTimer); // Use count for seconds held
                        statusText.innerText = "Holding: " + reps + "s";
                        statusText.className = "text-success fw-bold";
                    } else {
                        yogaHolding = false;
                        statusText.innerText = "Bend Knee into Warrior II";
                        statusText.className = "text-white";
                    }
                }
            }
            else if (currentExercise === 'Stretching') {
                // Side Stretch: Shoulder-Hip-Knee angle?
                // Or simply: check if wrist is high above head.
                const lShoulder = landmarks[11];
                const lElbow = landmarks[13];
                const lHip = landmarks[23];

                // Angle between Elbow-Shoulder-Hip (Arm overhead)
                if (lShoulder && lElbow && lHip) {
                    angle = findAngle(lElbow, lShoulder, lHip);
                    targetJoint = lShoulder;

                    if (angle > 140) { // Arm up
                        statusText.innerText = "Good Stretch!";
                        statusText.className = "text-success fw-bold";
                        reps++; // Just count frames/time active really, simplified to counter
                    } else {
                        statusText.innerText = "Reach Overhead";
                        statusText.className = "text-white";
                    }
                    // Divide by 30 to get approx seconds for UI
                    repCountSpan.innerText = Math.floor(reps / 20) + "s";
                }
            }
            else if (currentExercise === 'Pushups') {
                const shoulder = landmarks[11];
                const elbow = landmarks[13];
                const wrist = landmarks[15];

                if (shoulder && elbow && wrist) {
                    angle = findAngle(shoulder, elbow, wrist);
                    targetJoint = elbow;

                    if (angle > 160) {
                        stage = "UP";
                        statusText.innerText = "Go Down";
                        statusText.className = "text-white";
                    }
                    if (angle < 80 && stage === "UP") {
                        stage = "DOWN";
                        reps++;
                        speak("Push Up");
                        statusText.innerText = "Good Pushup!";
                        statusText.className = "text-success fw-bold";
                    }
                }
            }

            // 4. Update UI
            if (currentExercise === 'Stretching') {
                repCountSpan.innerText = Math.floor(reps / 20) + "s";
            } else {
                repCountSpan.innerText = reps;
            }

            if (targetJoint) {
                // Draw Angle
                canvasCtx.fillStyle = "white";
                canvasCtx.font = "bold 24px Arial";
                canvasCtx.fillText(Math.floor(angle) + "Â°", targetJoint.x * canvasElement.width + 10, targetJoint.y * canvasElement.height);
            }

        } else {
            statusText.innerText = "No Pose Detected";
        }
        canvasCtx.restore();
    }

    function endSession() {
        const statusDiv = document.getElementById('save-status');
        statusDiv.style.display = 'block';
        statusDiv.innerText = "Saving Session...";

        // Use reps directly, or convert time for yoga/stretching
        let finalDuration = reps * 5; // Default estimation
        if (currentExercise === 'Yoga' || currentExercise === 'Stretching') {
            finalDuration = reps; // It's already in seconds/frames
        }

        fetch('/save_posture_score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                score: Math.floor(postureScore),
                exercise: currentExercise,
                duration: finalDuration
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusDiv.className = "alert alert-success small mt-2";
                    statusDiv.innerText = "Session Saved! Redirecting...";
                    setTimeout(() => window.location.href = "{{ url_for('dashboard') }}", 2000);
                } else {
                    statusDiv.className = "alert alert-danger small mt-2";
                    statusDiv.innerText = "Error Saving.";
                }
            });
    }

    const pose = new Pose({
        locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }
    });

    pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        smoothSegmentation: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    pose.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await pose.send({ image: videoElement });
        },
        width: 800,
        height: 480
    });

    camera.start();
</script>
{% endblock %}